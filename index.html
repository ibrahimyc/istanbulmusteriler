import React, { useState, useEffect, useRef } from "react";
import { createClient } from "@supabase/supabase-js";

// âœ… SÄ°ZÄ°N SUPABASE BÄ°LGÄ°LERÄ°NÄ°Z
const supabaseUrl = "https://clqkrlricmbcmjhqlpjf.supabase.co";
const supabaseKey =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNscWtybHJpY21iY21qaHFscGpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4Nzc2NjQsImV4cCI6MjA2NjQ1MzY2NH0.AjM30gVPmf7a3NalaBeIoPgoozsoePkzs-UeFA10QqI";
const supabase = createClient(supabaseUrl, supabaseKey);

const KPIDashboard = () => {
  // Dashboard referansÄ± (screenshot iÃ§in)
  const dashboardRef = useRef(null);
  const metricsRef = useRef(null);

  // Ana state'ler
  const [activeTab, setActiveTab] = useState("dashboard");
  const [loading, setLoading] = useState(false);
  const [refreshing, setRefreshing] = useState(false);

  // Veri state'leri
  const [employees, setEmployees] = useState([
    {
      name: "Abdul Samet Dolu",
      team: "Ä°stanbul MÃ¼ÅŸteriler -4",
      segment: "BM",
      performance: 89.5,
    },
    {
      name: "AyÅŸe Ersoy",
      team: "Ä°stanbul MÃ¼ÅŸteriler -4",
      segment: "BM",
      performance: 101.2,
    },
    {
      name: "Batuhan Boyraz",
      team: "Ä°stanbul MÃ¼ÅŸteriler -3",
      segment: "BM",
      performance: 93.7,
    },
    {
      name: "Burcu Cebeci",
      team: "Ä°stanbul MÃ¼ÅŸteriler -1",
      segment: "Ã–M",
      performance: 95.8,
    },
    {
      name: "Duygu Maranci",
      team: "Ä°stanbul MÃ¼ÅŸteriler -1",
      segment: "BM",
      performance: 87.4,
    },
    {
      name: "Ece Karaman",
      team: "Ä°stanbul MÃ¼ÅŸteriler -3",
      segment: "BM",
      performance: 96.1,
    },
    {
      name: "Efe Acar",
      team: "Ä°stanbul MÃ¼ÅŸteriler -2",
      segment: "BM",
      performance: 91.3,
    },
    {
      name: "Ekrem GÃ¼ler",
      team: "Ä°stanbul MÃ¼ÅŸteriler -1",
      segment: "Ã–M",
      performance: 88.9,
    },
    {
      name: "Hasan Aycan YÄ±lmaz",
      team: "Ä°stanbul MÃ¼ÅŸteriler -3",
      segment: "BM",
      performance: 92.6,
    },
    {
      name: "Kaan Yasin DinÃ§er",
      team: "Ä°stanbul MÃ¼ÅŸteriler -2",
      segment: "BM",
      performance: 90.1,
    },
    {
      name: "Kenan Furuncu",
      team: "Ä°stanbul MÃ¼ÅŸteriler -4",
      segment: "Ã–M",
      performance: 94.3,
    },
    {
      name: "Mert BayramoÄŸlu",
      team: "Ä°stanbul MÃ¼ÅŸteriler -1",
      segment: "Ã–M",
      performance: 99.1,
    },
    {
      name: "Merve Vural",
      team: "Ä°stanbul MÃ¼ÅŸteriler -3",
      segment: "BM",
      performance: 85.7,
    },
    {
      name: "Murat Altun",
      team: "Ä°stanbul MÃ¼ÅŸteriler -4",
      segment: "BM",
      performance: 93.2,
    },
    {
      name: "Mustafa KarayandÄ±",
      team: "Ä°stanbul MÃ¼ÅŸteriler -2",
      segment: "BM",
      performance: 89.8,
    },
    {
      name: "MÃ¼rÃ¼vvet Emek",
      team: "Ä°stanbul MÃ¼ÅŸteriler -4",
      segment: "Ã–M",
      performance: 97.4,
    },
    {
      name: "Naile SÃ¼rmeli",
      team: "Ä°stanbul MÃ¼ÅŸteriler -4",
      segment: "BM",
      performance: 91.6,
    },
    {
      name: "Nida Ezer",
      team: "Ä°stanbul MÃ¼ÅŸteriler -1",
      segment: "BM",
      performance: 86.3,
    },
    {
      name: "Ã–mer Emre Ã‡eltekoÄŸlu",
      team: "Ä°stanbul MÃ¼ÅŸteriler -2",
      segment: "Ã–M",
      performance: 92.9,
    },
    {
      name: "Samet CÃ¶mert",
      team: "Ä°stanbul MÃ¼ÅŸteriler -2",
      segment: "Ã–M",
      performance: 88.1,
    },
    {
      name: "Semih ErkÄ±lÄ±Ã§",
      team: "Ä°stanbul MÃ¼ÅŸteriler -1",
      segment: "BM",
      performance: 95.2,
    },
    {
      name: "Serdar TahtalÄ±",
      team: "Ä°stanbul MÃ¼ÅŸteriler -3",
      segment: "Ã–M",
      performance: 90.7,
    },
    {
      name: "Seyhan Erol",
      team: "Ä°stanbul MÃ¼ÅŸteriler -4",
      segment: "Ã–M",
      performance: 87.8,
    },
    {
      name: "Åeniz TÃ¼redi GÃ¼Ã§lÃ¼",
      team: "Ä°stanbul MÃ¼ÅŸteriler -2",
      segment: "Ã–M",
      performance: 94.6,
    },
    {
      name: "Taylan Murat Seymen",
      team: "Ä°stanbul MÃ¼ÅŸteriler -1",
      segment: "BM",
      performance: 89.4,
    },
    {
      name: "Vivet Bahar",
      team: "Ä°stanbul MÃ¼ÅŸteriler -2",
      segment: "Ã–M",
      performance: 93.8,
    },
    {
      name: "Yasemin AÄŸaÃ§bÃ¼ken ÃœÃ§ler",
      team: "Ä°stanbul MÃ¼ÅŸteriler -3",
      segment: "Ã–M",
      performance: 91.9,
    },
    {
      name: "YiÄŸit Mert Demir",
      team: "Ä°stanbul MÃ¼ÅŸteriler -3",
      segment: "BM",
      performance: 88.5,
    },
  ]);

  const [dataEntries, setDataEntries] = useState([]);
  const [teams, setTeams] = useState([
    { name: "Ä°stanbul MÃ¼ÅŸteriler -1", password: "team1234" },
    { name: "Ä°stanbul MÃ¼ÅŸteriler -2", password: "team1234" },
    { name: "Ä°stanbul MÃ¼ÅŸteriler -3", password: "team1234" },
    { name: "Ä°stanbul MÃ¼ÅŸteriler -4", password: "team1234" },
  ]);
  const [kpiTargets, setKpiTargets] = useState({
    calls: 45,
    proposals: 5,
    online_visits: 2,
    physical_visits: 1,
    total_visits: 3,
  });
  const [adminSettings, setAdminSettings] = useState({
    admin_password: "admin123",
  });

  // Form state'leri
  const [formData, setFormData] = useState({
    date: new Date().toISOString().split("T")[0],
    employee: "",
    calls: "",
    proposals: "",
    onlineVisits: "",
    physicalVisits: "",
    onLeave: false,
  });

  const [bulkFormData, setBulkFormData] = useState({
    date: new Date().toISOString().split("T")[0],
    team: "",
    employees: [],
  });

  const [selectedEmployee, setSelectedEmployee] = useState(null);

  // Modal state'leri
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [showPasswordModal, setShowPasswordModal] = useState(false);
  const [showBulkModal, setShowBulkModal] = useState(false);
  const [showBulkPasswordModal, setShowBulkPasswordModal] = useState(false);
  const [showEmailModal, setShowEmailModal] = useState(false);
  const [deleteType, setDeleteType] = useState("");
  const [deleteTarget, setDeleteTarget] = useState("");
  const [passwordInput, setPasswordInput] = useState("");
  const [oldPasswordInput, setOldPasswordInput] = useState("");
  const [newPasswordInput, setNewPasswordInput] = useState("");
  const [passwordAction, setPasswordAction] = useState("");
  const [emailData, setEmailData] = useState({
    recipient: "",
    subject: "",
    type: "",
  });

  // Admin form state'leri
  const [adminFormData, setAdminFormData] = useState({
    newEmployee: { name: "", team: "", segment: "BM" },
    kpiUpdates: {},
    passwordUpdates: {},
  });

  // Sayfa yÃ¼klendiÄŸinde
  useEffect(() => {
    loadAllData();
  }, []);

  // TÃ¼m verileri yÃ¼kle
  const loadAllData = async () => {
    await Promise.all([
      loadDataFromSupabase(),
      loadTeams(),
      loadKpiTargets(),
      loadAdminSettings(),
    ]);
    setTimeout(() => updateEmployeePerformances(), 500);
  };

  // Verileri yenile (manuel)
  const refreshData = async () => {
    setRefreshing(true);
    await loadAllData();
    updateEmployeePerformances();
    setRefreshing(false);
    alert("âœ… Veriler yenilendi!");
  };

  // Ã‡alÄ±ÅŸan performanslarÄ±nÄ± gÃ¼ncelle
  const updateEmployeePerformances = () => {
    const currentMonth = new Date().toISOString().slice(0, 7);
    const monthlyEntries = dataEntries.filter(
      (e) => e.date.startsWith(currentMonth) && !e.on_leave,
    );

    setEmployees((prevEmployees) =>
      prevEmployees.map((emp) => {
        const empEntries = monthlyEntries.filter(
          (e) => e.employee === emp.name,
        );
        if (empEntries.length === 0) return { ...emp, performance: 85.0 };

        const avgCalls =
          empEntries.reduce((sum, e) => sum + (e.calls || 0), 0) /
          empEntries.length;
        const avgProposals =
          empEntries.reduce((sum, e) => sum + (e.proposals || 0), 0) /
          empEntries.length;
        const avgVisits =
          empEntries.reduce((sum, e) => sum + (e.total_visits || 0), 0) /
          empEntries.length;

        const performance =
          ((avgCalls / (kpiTargets.calls || 45)) * 40 +
            (avgProposals / (kpiTargets.proposals || 5)) * 30 +
            (avgVisits / (kpiTargets.total_visits || 3)) * 30) *
          100;

        return { ...emp, performance: Math.min(performance, 150) };
      }),
    );
  };

  // Ä°ÅŸ gÃ¼nÃ¼ hesaplama fonksiyonu
  const getWorkDaysInMonth = (year, month) => {
    let workDays = 0;
    const daysInMonth = new Date(year, month + 1, 0).getDate(); // AyÄ±n son gÃ¼nÃ¼

    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(year, month, day);
      const dayOfWeek = date.getDay();
      // Pazartesi(1) - Cuma(5) arasÄ± iÅŸ gÃ¼nÃ¼ sayÄ±lÄ±r
      if (dayOfWeek >= 1 && dayOfWeek <= 5) {
        workDays++;
      }
    }

    return workDays;
  };

  // GeÃ§miÅŸ iÅŸ gÃ¼nlerini hesaplama (bugÃ¼ne kadar)
  const getWorkDaysUntilToday = (year, month) => {
    let workDays = 0;
    const today = new Date();
    const currentDay = today.getDate();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();

    // EÄŸer gelecek ay ise 0 dÃ¶ndÃ¼r
    if (year > currentYear || (year === currentYear && month > currentMonth)) {
      return 0;
    }

    // EÄŸer geÃ§miÅŸ ay ise tÃ¼m iÅŸ gÃ¼nlerini say
    if (year < currentYear || (year === currentYear && month < currentMonth)) {
      return getWorkDaysInMonth(year, month);
    }

    // Bu ay ise bugÃ¼ne kadar olan iÅŸ gÃ¼nlerini say
    for (let day = 1; day <= currentDay; day++) {
      const date = new Date(year, month, day);
      const dayOfWeek = date.getDay();
      if (dayOfWeek >= 1 && dayOfWeek <= 5) {
        workDays++;
      }
    }

    return workDays;
  };

  // Export to Excel function
  const exportToExcel = (data, filename) => {
    const csvContent =
      "data:text/csv;charset=utf-8," +
      Object.keys(data[0]).join(",") +
      "\n" +
      data.map((row) => Object.values(row).join(",")).join("\n");

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute(
      "download",
      `${filename}_${new Date().toISOString().split("T")[0]}.csv`,
    );
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // Screenshot ve WhatsApp functions
  const takeScreenshot = () => {
    return new Promise((resolve) => {
      if (!metricsRef.current) {
        resolve(null);
        return;
      }

      // html2canvas'Ä± dinamik olarak yÃ¼kle
      if (!window.html2canvas) {
        const script = document.createElement("script");
        script.src =
          "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
        script.onload = () => {
          captureElement();
        };
        script.onerror = () => {
          console.error("html2canvas yÃ¼klenemedi");
          resolve(null);
        };
        document.head.appendChild(script);
      } else {
        captureElement();
      }

      function captureElement() {
        try {
          window
            .html2canvas(metricsRef.current, {
              backgroundColor: "#ffffff",
              scale: 2,
              logging: false,
              useCORS: true,
              allowTaint: true,
              width: metricsRef.current.scrollWidth,
              height: metricsRef.current.scrollHeight,
            })
            .then((canvas) => {
              const dataURL = canvas.toDataURL("image/png", 0.9);
              resolve(dataURL);
            })
            .catch((error) => {
              console.error("Screenshot alma hatasÄ±:", error);
              resolve(null);
            });
        } catch (error) {
          console.error("html2canvas hatasÄ±:", error);
          resolve(null);
        }
      }
    });
  };

  const sendEmail = async (type, data = null) => {
    setShowEmailModal(false);

    if (type === "screenshot") {
      alert("ğŸ“¸ GÃ¼nlÃ¼k ortalamalar screenshot alÄ±nÄ±yor...");
      const screenshot = await takeScreenshot();

      const emailContent = screenshot
        ? "GÃ¼nlÃ¼k ortalamalar gÃ¶rÃ¼ntÃ¼sÃ¼ ekte yer almaktadÄ±r."
        : "Dashboard metinsel Ã¶zeti ekte yer almaktadÄ±r.";

      alert(
        `ğŸ“§ Email gÃ¶nderildi!\nAlÄ±cÄ±: ${emailData.recipient}\nKonu: ${emailData.subject}\nÄ°Ã§erik: ${emailContent}`,
      );
    } else {
      const emailContent = "Rapor dosyasÄ± ekte yer almaktadÄ±r.";
      alert(
        `ğŸ“§ Email gÃ¶nderildi!\nAlÄ±cÄ±: ${emailData.recipient}\nKonu: ${emailData.subject}\nÄ°Ã§erik: ${emailContent}`,
      );
    }
  };

  const sendWhatsApp = async () => {
    // Ã–nce kullanÄ±cÄ±ya bilgi ver
    alert("ğŸ“¸ GÃ¼nlÃ¼k ortalamalar screenshot alÄ±nÄ±yor, lÃ¼tfen bekleyin...");

    const screenshot = await takeScreenshot();
    const currentMetrics = calculateMetrics();

    const message = `ğŸ“Š Ä°stanbul MÃ¼ÅŸteriler KPI Dashboard - ${new Date().toLocaleDateString("tr-TR")}

ğŸ“ˆ GÃ¼nlÃ¼k Ortalamalar:
â€¢ Arama: ${currentMetrics.avgCalls}
â€¢ Teklif: ${currentMetrics.avgProposals}  
â€¢ Online Ziyaret: ${currentMetrics.avgOnline}
â€¢ Fiziki Ziyaret: ${currentMetrics.avgPhysical}
â€¢ Toplam Ziyaret: ${currentMetrics.avgTotal}
â€¢ Aktif Ã‡alÄ±ÅŸan: ${currentMetrics.activeCount}/${employees.length}

GÃ¼nlÃ¼k ortalamalar gÃ¶rÃ¼ntÃ¼sÃ¼ ekte!`;

    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;

    if (screenshot) {
      // Screenshot'Ä± yeni pencerede gÃ¶ster ve WhatsApp link'i ile birlikte sun
      const newWindow = window.open("", "_blank");
      newWindow.document.write(`
        <html>
          <head>
            <title>ğŸ“Š GÃ¼nlÃ¼k Ortalamalar Screenshot</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
              .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
              .header { background: #8315b5; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
              .screenshot { width: 100%; border: 2px solid #8315b5; border-radius: 8px; margin: 20px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
              .buttons { text-align: center; margin: 20px 0; }
              .btn { background: #25D366; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 0 10px; display: inline-block; }
              .btn:hover { background: #1da851; }
              .download-btn { background: #007bff; }
              .download-btn:hover { background: #0056b3; }
              .info { background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #28a745; }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <h1>ğŸ“Š GÃ¼nlÃ¼k Ortalamalar</h1>
                <p>${new Date().toLocaleDateString("tr-TR", { weekday: "long", year: "numeric", month: "long", day: "numeric" })}</p>
              </div>

              <div class="info">
                <strong>ğŸ“ˆ Performans Ã–zeti:</strong><br>
                â€¢ Ortalama Arama: ${currentMetrics.avgCalls}<br>
                â€¢ Ortalama Teklif: ${currentMetrics.avgProposals}<br>
                â€¢ Ortalama Online Ziyaret: ${currentMetrics.avgOnline}<br>
                â€¢ Ortalama Fiziki Ziyaret: ${currentMetrics.avgPhysical}<br>
                â€¢ Ortalama Toplam Ziyaret: ${currentMetrics.avgTotal}<br>
                â€¢ Aktif Ã‡alÄ±ÅŸan: ${currentMetrics.activeCount}/${employees.length}
              </div>

              <img src="${screenshot}" alt="GÃ¼nlÃ¼k Ortalamalar" class="screenshot" />

              <div class="buttons">
                <a href="${whatsappUrl}" target="_blank" class="btn">ğŸ“± WhatsApp'ta PaylaÅŸ</a>
                <a href="${screenshot}" download="gunluk-ortalamalar-${new Date().toISOString().split("T")[0]}.png" class="btn download-btn">ğŸ’¾ Resmi Ä°ndir</a>
              </div>

              <div class="info">
                <strong>ğŸ’¡ KullanÄ±m:</strong><br>
                1. ğŸ“± "WhatsApp'ta PaylaÅŸ" ile mesajÄ± gÃ¶nderin<br>
                2. ğŸ’¾ "Resmi Ä°ndir" ile gÃ¶rseli kaydedin<br>
                3. WhatsApp'ta resmi manuel olarak ekleyebilirsiniz
              </div>
            </div>
          </body>
        </html>
      `);

      alert("âœ… GÃ¼nlÃ¼k ortalamalar screenshot alÄ±ndÄ±! Yeni pencere aÃ§Ä±ldÄ±.");
    } else {
      // Screenshot alÄ±namazsa sadece mesajÄ± gÃ¶nder
      window.open(whatsappUrl, "_blank");
      alert("âš ï¸ Screenshot alÄ±namadÄ±, sadece metin mesajÄ± paylaÅŸÄ±lacak.");
    }
  };

  // Supabase iÅŸlemleri
  const loadDataFromSupabase = async () => {
    try {
      setLoading(true);
      const { data, error } = await supabase
        .from("data_entries")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        console.error("Veri yÃ¼kleme hatasÄ±:", error);
      } else {
        setDataEntries(data || []);
      }
    } catch (error) {
      console.error("Beklenmeyen hata:", error);
    } finally {
      setLoading(false);
    }
  };

  const loadTeams = async () => {
    try {
      const { data, error } = await supabase.from("teams").select("*");
      if (!error && data && data.length > 0) {
        setTeams(data);
      }
    } catch (error) {
      console.error("Ekip yÃ¼kleme hatasÄ±:", error);
    }
  };

  const loadKpiTargets = async () => {
    try {
      const { data, error } = await supabase.from("kpi_targets").select("*");
      if (!error && data && data.length > 0) {
        const targets = {};
        data.forEach((item) => {
          targets[item.metric_name] = item.target_value;
        });
        setKpiTargets(targets);
      }
    } catch (error) {
      console.error("KPI hedef yÃ¼kleme hatasÄ±:", error);
    }
  };

  const loadAdminSettings = async () => {
    try {
      const { data, error } = await supabase.from("admin_settings").select("*");
      if (!error && data && data.length > 0) {
        const settings = {};
        data.forEach((item) => {
          settings[item.setting_name] = item.setting_value;
        });
        setAdminSettings(settings);
      }
    } catch (error) {
      console.error("Admin ayar yÃ¼kleme hatasÄ±:", error);
    }
  };

  const verifyPassword = (password, type, teamName = null) => {
    if (type === "admin") {
      return password === adminSettings.admin_password;
    } else if (type === "team" && teamName) {
      const team = teams.find((t) => t.name === teamName);
      return team && password === team.password;
    }
    return false;
  };

  const saveToSupabase = async (entryData) => {
    try {
      setLoading(true);

      const calls = entryData.onLeave ? 0 : parseInt(entryData.calls) || 0;
      const proposals = entryData.onLeave
        ? 0
        : parseInt(entryData.proposals) || 0;
      const onlineVisits = entryData.onLeave
        ? 0
        : parseInt(entryData.onlineVisits) || 0;
      const physicalVisits = entryData.onLeave
        ? 0
        : parseInt(entryData.physicalVisits) || 0;

      const { data, error } = await supabase
        .from("data_entries")
        .insert([
          {
            date: entryData.date,
            employee: entryData.employee,
            team: selectedEmployee?.team || "",
            calls: calls,
            proposals: proposals,
            online_visits: onlineVisits,
            physical_visits: physicalVisits,
            total_visits: onlineVisits + physicalVisits,
            on_leave: entryData.onLeave === true,
          },
        ])
        .select();

      if (error) {
        alert("âŒ Veri kaydedilemedi: " + error.message);
        return false;
      } else {
        await loadDataFromSupabase();
        return true;
      }
    } catch (error) {
      alert("âŒ Beklenmeyen hata: " + error.message);
      return false;
    } finally {
      setLoading(false);
    }
  };

  // VERÄ° SÄ°LME FONKSÄ°YONLARI
  const deleteIndividualData = async (employeeName, date) => {
    const password = prompt("Admin ÅŸifresi girin:");
    if (!verifyPassword(password, "admin")) {
      alert("âŒ YanlÄ±ÅŸ admin ÅŸifresi!");
      return;
    }

    if (
      confirm(
        `${employeeName} iÃ§in ${date} tarihli veriyi silmek istediÄŸinizden emin misiniz?`,
      )
    ) {
      try {
        const { error } = await supabase
          .from("data_entries")
          .delete()
          .eq("employee", employeeName)
          .eq("date", date);

        if (error) {
          alert("âŒ Veri silinemedi: " + error.message);
        } else {
          await loadDataFromSupabase();
          alert("âœ… Veri silindi!");
        }
      } catch (error) {
        alert("âŒ Hata: " + error.message);
      }
    }
  };

  const deleteTeamData = async (teamName, date) => {
    const password = prompt("Admin ÅŸifresi girin:");
    if (!verifyPassword(password, "admin")) {
      alert("âŒ YanlÄ±ÅŸ admin ÅŸifresi!");
      return;
    }

    if (
      confirm(
        `${teamName} ekibi iÃ§in ${date} tarihli tÃ¼m verileri silmek istediÄŸinizden emin misiniz?`,
      )
    ) {
      try {
        const { error } = await supabase
          .from("data_entries")
          .delete()
          .eq("team", teamName)
          .eq("date", date);

        if (error) {
          alert("âŒ Veriler silinemedi: " + error.message);
        } else {
          await loadDataFromSupabase();
          alert("âœ… Ekip verileri silindi!");
        }
      } catch (error) {
        alert("âŒ Hata: " + error.message);
      }
    }
  };

  const deleteAllData = async (date) => {
    const password = prompt("Admin ÅŸifresi girin:");
    if (!verifyPassword(password, "admin")) {
      alert("âŒ YanlÄ±ÅŸ admin ÅŸifresi!");
      return;
    }

    if (
      confirm(
        `${date} tarihli TÃœM verileri silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!`,
      )
    ) {
      try {
        const { error } = await supabase
          .from("data_entries")
          .delete()
          .eq("date", date);

        if (error) {
          alert("âŒ Veriler silinemedi: " + error.message);
        } else {
          await loadDataFromSupabase();
          alert("âœ… TÃ¼m veriler silindi!");
        }
      } catch (error) {
        alert("âŒ Hata: " + error.message);
      }
    }
  };

  // Toplu iÅŸlem fonksiyonlarÄ±
  const handleBulkTeamSelect = (teamName) => {
    const teamEmployees = employees.filter((emp) => emp.team === teamName);
    setBulkFormData((prev) => ({
      ...prev,
      team: teamName,
      employees: teamEmployees.map((emp) => ({
        name: emp.name,
        calls: "",
        proposals: "",
        onlineVisits: "",
        physicalVisits: "",
        onLeave: false,
      })),
    }));
  };

  const handleBulkEmployeeChange = (index, field, value) => {
    setBulkFormData((prev) => ({
      ...prev,
      employees: prev.employees.map((emp, i) =>
        i === index ? { ...emp, [field]: value } : emp,
      ),
    }));
  };

  const submitBulkData = async () => {
    const password = prompt(`${bulkFormData.team} ekibi iÃ§in ÅŸifre girin:`);
    const isValid = verifyPassword(password, "team", bulkFormData.team);

    if (!isValid) {
      alert("âŒ YanlÄ±ÅŸ ÅŸifre!");
      return;
    }

    let successCount = 0;
    for (const emp of bulkFormData.employees) {
      const entryData = {
        date: bulkFormData.date,
        employee: emp.name,
        calls: emp.calls,
        proposals: emp.proposals,
        onlineVisits: emp.onlineVisits,
        physicalVisits: emp.physicalVisits,
        onLeave: emp.onLeave,
      };

      const empObj = employees.find((e) => e.name === emp.name);
      setSelectedEmployee(empObj);

      const success = await saveToSupabase(entryData);
      if (success) successCount++;
    }

    // Dashboard'Ä± gÃ¼ncelle
    await loadDataFromSupabase();
    updateEmployeePerformances();

    alert(
      `âœ… ${successCount}/${bulkFormData.employees.length} kayÄ±t baÅŸarÄ±yla kaydedildi!`,
    );
    setBulkFormData({
      date: new Date().toISOString().split("T")[0],
      team: "",
      employees: [],
    });
  };

  // Admin fonksiyonlarÄ±
  const addNewEmployee = async () => {
    const password = prompt("Admin ÅŸifresi girin:");
    const isValid = verifyPassword(password, "admin");

    if (!isValid) {
      alert("âŒ YanlÄ±ÅŸ admin ÅŸifresi!");
      return;
    }

    if (!adminFormData.newEmployee.name || !adminFormData.newEmployee.team) {
      alert("âŒ Ä°sim ve ekip alanlarÄ± zorunlu!");
      return;
    }

    setEmployees((prev) => [
      ...prev,
      {
        ...adminFormData.newEmployee,
        performance: 85.0,
      },
    ]);

    setAdminFormData((prev) => ({
      ...prev,
      newEmployee: { name: "", team: "", segment: "BM" },
    }));

    alert("âœ… Yeni Ã§alÄ±ÅŸan eklendi!");
  };

  const updateKpiTargets = async () => {
    const password = prompt("Admin ÅŸifresi girin:");
    const isValid = verifyPassword(password, "admin");

    if (!isValid) {
      alert("âŒ YanlÄ±ÅŸ admin ÅŸifresi!");
      return;
    }

    setKpiTargets((prev) => ({ ...prev, ...adminFormData.kpiUpdates }));
    alert("âœ… KPI hedefleri gÃ¼ncellendi!");
  };

  const deleteEmployee = async (employeeName) => {
    const password = prompt("Admin ÅŸifresi girin:");
    const isValid = verifyPassword(password, "admin");

    if (!isValid) {
      alert("âŒ YanlÄ±ÅŸ admin ÅŸifresi!");
      return;
    }

    if (
      confirm(
        `${employeeName} adlÄ± Ã§alÄ±ÅŸanÄ± silmek istediÄŸinizden emin misiniz?`,
      )
    ) {
      setEmployees((prev) => prev.filter((emp) => emp.name !== employeeName));
      alert("âœ… Ã‡alÄ±ÅŸan silindi!");
    }
  };

  // ÅÄ°FRE YÃ–NETÄ°MÄ° FONKSÄ°YONLARI (DÃœZELTÄ°LDÄ°)
  const changeAdminPassword = async () => {
    if (!oldPasswordInput || !newPasswordInput) {
      alert("âŒ TÃ¼m alanlarÄ± doldurun!");
      return;
    }

    const isValid = verifyPassword(oldPasswordInput, "admin");
    if (!isValid) {
      alert("âŒ Mevcut ÅŸifre yanlÄ±ÅŸ!");
      return;
    }

    // Admin ÅŸifresini gÃ¼ncelle
    setAdminSettings((prev) => ({ ...prev, admin_password: newPasswordInput }));
    setOldPasswordInput("");
    setNewPasswordInput("");
    alert("âœ… Admin ÅŸifresi gÃ¼ncellendi!");
  };

  const changeTeamPassword = async (teamName) => {
    const oldPassword = prompt(`${teamName} iÃ§in mevcut ÅŸifre:`);
    const isValid = verifyPassword(oldPassword, "team", teamName);

    if (!isValid) {
      alert("âŒ Mevcut ÅŸifre yanlÄ±ÅŸ!");
      return;
    }

    const newPassword = prompt("Yeni ÅŸifre:");
    if (!newPassword) return;

    // Ekip ÅŸifresini gÃ¼ncelle
    setTeams((prev) =>
      prev.map((team) =>
        team.name === teamName ? { ...team, password: newPassword } : team,
      ),
    );

    alert("âœ… Ekip ÅŸifresi gÃ¼ncellendi!");
  };

  // CSS Styles (Yeni tema rengiyle)
  const styles = {
    container: {
      maxWidth: "1400px",
      margin: "0 auto",
      background: "white",
      minHeight: "100vh",
      boxShadow: "0 0 30px rgba(0, 0, 0, 0.3)",
    },
    header: {
      background: "linear-gradient(135deg, #8315b5, #5a0e7a)",
      color: "white",
      padding: "20px",
      textAlign: "center",
      borderBottom: "4px solid #8315b5",
    },
    headerTitle: {
      fontSize: "2.2em",
      marginBottom: "5px",
      fontWeight: "600",
      textShadow: "0 2px 4px rgba(0, 0, 0, 0.3)",
    },
    navBar: {
      background: "#f8f9fa",
      padding: "0",
      display: "flex",
      boxShadow: "0 2px 4px rgba(0, 0, 0, 0.1)",
      flexWrap: "wrap",
      borderBottom: "1px solid #dee2e6",
    },
    navTab: {
      flex: "1",
      background: "#e9ecef",
      border: "none",
      padding: "15px 8px",
      cursor: "pointer",
      fontWeight: "600",
      color: "#495057",
      transition: "all 0.3s ease",
      borderBottom: "3px solid transparent",
      minWidth: "120px",
      fontSize: "13px",
    },
    navTabActive: {
      background: "white",
      color: "#8315b5",
      borderBottom: "3px solid #8315b5",
      boxShadow: "0 -2px 8px rgba(131, 21, 181, 0.2)",
    },
    content: {
      padding: "30px",
    },
    metricsGrid: {
      display: "grid",
      gridTemplateColumns: "repeat(auto-fit, minmax(250px, 1fr))",
      gap: "20px",
      marginBottom: "30px",
    },
    metricCard: {
      background: "linear-gradient(145deg, #fff, #f8f9fa)",
      borderRadius: "12px",
      padding: "25px",
      textAlign: "center",
      boxShadow: "0 4px 15px rgba(0, 0, 0, 0.1)",
      borderLeft: "4px solid #8315b5",
      transition: "all 0.3s ease",
      position: "relative",
      overflow: "hidden",
    },
    metricValue: {
      fontSize: "2.5em",
      fontWeight: "bold",
      color: "#8315b5",
      marginBottom: "10px",
      textShadow: "0 1px 2px rgba(0, 0, 0, 0.1)",
    },
    metricLabel: {
      color: "#6c757d",
      fontWeight: "600",
      fontSize: "0.9em",
      marginBottom: "8px",
    },
    progressBar: {
      width: "100%",
      height: "8px",
      background: "#e9ecef",
      borderRadius: "4px",
      overflow: "hidden",
      margin: "10px 0",
      boxShadow: "inset 0 1px 3px rgba(0, 0, 0, 0.1)",
    },
    progressFill: {
      height: "100%",
      borderRadius: "4px",
      transition: "width 0.5s ease",
    },
    progressExcellent: {
      background: "linear-gradient(90deg, #28a745, #20c997)",
    },
    progressGood: {
      background: "linear-gradient(90deg, #ffc107, #fd7e14)",
    },
    formContainer: {
      background: "white",
      borderRadius: "12px",
      padding: "30px",
      boxShadow: "0 4px 15px rgba(0, 0, 0, 0.1)",
      marginBottom: "30px",
      border: "1px solid #e9ecef",
    },
    formGrid: {
      display: "grid",
      gridTemplateColumns: "repeat(auto-fit, minmax(300px, 1fr))",
      gap: "25px",
    },
    formGroup: {
      marginBottom: "20px",
    },
    label: {
      display: "block",
      marginBottom: "8px",
      color: "#495057",
      fontWeight: "600",
      fontSize: "0.9em",
    },
    formControl: {
      width: "100%",
      padding: "12px 15px",
      border: "2px solid #e9ecef",
      borderRadius: "8px",
      fontSize: "14px",
      transition: "all 0.3s ease",
      background: "white",
    },
    autoField: {
      background: "#e8f5e8",
      border: "2px solid #28a745",
      color: "#155724",
      fontWeight: "600",
      padding: "12px 15px",
      borderRadius: "8px",
      fontSize: "14px",
    },
    btn: {
      background: "linear-gradient(145deg, #8315b5, #5a0e7a)",
      color: "white",
      border: "none",
      padding: "15px 30px",
      borderRadius: "8px",
      fontWeight: "600",
      cursor: "pointer",
      fontSize: "16px",
      transition: "all 0.3s ease",
      boxShadow: "0 4px 10px rgba(131, 21, 181, 0.3)",
      margin: "5px",
      textTransform: "uppercase",
      letterSpacing: "0.5px",
    },
    btnSuccess: {
      background: "linear-gradient(145deg, #28a745, #20c997)",
      boxShadow: "0 4px 10px rgba(40, 167, 69, 0.3)",
    },
    btnDanger: {
      background: "linear-gradient(145deg, #dc3545, #c82333)",
      boxShadow: "0 4px 10px rgba(220, 53, 69, 0.3)",
    },
    btnWarning: {
      background: "linear-gradient(145deg, #ffc107, #e0a800)",
      color: "#212529",
      boxShadow: "0 4px 10px rgba(255, 193, 7, 0.3)",
    },
    btnInfo: {
      background: "linear-gradient(145deg, #17a2b8, #138496)",
      boxShadow: "0 4px 10px rgba(23, 162, 184, 0.3)",
    },
    modal: {
      display: "none",
      position: "fixed",
      zIndex: 1000,
      left: 0,
      top: 0,
      width: "100%",
      height: "100%",
      backgroundColor: "rgba(0, 0, 0, 0.5)",
      backdropFilter: "blur(5px)",
    },
    modalOpen: {
      display: "flex",
      alignItems: "center",
      justifyContent: "center",
    },
    modalContent: {
      backgroundColor: "#fefefe",
      padding: "30px",
      borderRadius: "12px",
      width: "90%",
      maxWidth: "500px",
      boxShadow: "0 8px 25px rgba(0, 0, 0, 0.3)",
      position: "relative",
      maxHeight: "80vh",
      overflowY: "auto",
    },
    table: {
      width: "100%",
      borderCollapse: "collapse",
      background: "white",
      borderRadius: "8px",
      overflow: "hidden",
      boxShadow: "0 4px 15px rgba(0, 0, 0, 0.1)",
      marginTop: "20px",
    },
    tableHeader: {
      background: "linear-gradient(145deg, #8315b5, #5a0e7a)",
      color: "white",
      padding: "15px 12px",
      textAlign: "left",
      fontWeight: "600",
      fontSize: "0.9em",
      textTransform: "uppercase",
      letterSpacing: "0.5px",
    },
    tableCell: {
      padding: "12px",
      borderBottom: "1px solid #e9ecef",
      fontSize: "0.9em",
    },
    statusInfo: {
      padding: "15px",
      borderRadius: "8px",
      marginBottom: "20px",
      border: "1px solid",
      fontWeight: "bold",
    },
    statusSuccess: {
      background: "#d4edda",
      color: "#155724",
      borderColor: "#28a745",
    },
    statusWarning: {
      background: "#fff3cd",
      color: "#856404",
      borderColor: "#ffc107",
    },
    statusError: {
      background: "#f8d7da",
      color: "#721c24",
      borderColor: "#dc3545",
    },
    adminCard: {
      background: "linear-gradient(145deg, #fff, #f8f9fa)",
      border: "2px solid #ffc107",
      borderRadius: "12px",
      padding: "25px",
      marginBottom: "20px",
      boxShadow: "0 4px 15px rgba(0, 0, 0, 0.1)",
    },
    hierarchyContainer: {
      marginBottom: "30px",
    },
    teamHeader: {
      background: "linear-gradient(145deg, #8315b5, #5a0e7a)",
      color: "white",
      padding: "15px 20px",
      borderRadius: "8px",
      marginBottom: "15px",
      fontSize: "1.2em",
      fontWeight: "bold",
      cursor: "pointer",
      transition: "all 0.3s ease",
    },
    employeeList: {
      marginLeft: "20px",
      marginBottom: "20px",
    },
    employeeItem: {
      background: "#f8f9fa",
      padding: "10px 15px",
      borderRadius: "6px",
      marginBottom: "8px",
      borderLeft: "4px solid #28a745",
      display: "flex",
      justifyContent: "space-between",
      alignItems: "center",
    },
    exportButtons: {
      display: "flex",
      gap: "10px",
      marginBottom: "20px",
      flexWrap: "wrap",
    },
    bulkGrid: {
      display: "grid",
      gridTemplateColumns: "repeat(auto-fit, minmax(150px, 1fr))",
      gap: "10px",
      marginBottom: "15px",
    },
    bulkInput: {
      padding: "8px",
      border: "1px solid #ddd",
      borderRadius: "4px",
      fontSize: "12px",
    },
    passwordHidden: {
      background: "#f0f0f0",
      border: "2px solid #8315b5",
      color: "#8315b5",
      fontWeight: "600",
      padding: "12px 15px",
      borderRadius: "8px",
      fontSize: "14px",
      letterSpacing: "2px",
    },
  };

  // Event handlers
  const handleInputChange = (e) => {
    const { name, value, type, checked } = e.target;
    setFormData((prev) => ({
      ...prev,
      [name]: type === "checkbox" ? checked : value,
    }));

    if (name === "employee") {
      const emp = employees.find((e) => e.name === value);
      setSelectedEmployee(emp || null);
    }
  };

  const handleSubmit = async () => {
    if (!formData.employee) {
      alert("âŒ LÃ¼tfen Ã§alÄ±ÅŸan seÃ§in!");
      return;
    }

    const success = await saveToSupabase(formData);

    if (success) {
      setFormData({
        date: new Date().toISOString().split("T")[0],
        employee: "",
        calls: "",
        proposals: "",
        onlineVisits: "",
        physicalVisits: "",
        onLeave: false,
      });
      setSelectedEmployee(null);
      alert("âœ… Veri baÅŸarÄ±yla kaydedildi!");
    }
  };

  const openEmailModal = (type, data = null) => {
    setEmailData({
      recipient: "",
      subject:
        type === "screenshot" ? "Dashboard Ekran GÃ¶rÃ¼ntÃ¼sÃ¼" : "Rapor DosyasÄ±",
      type: type,
      data: data,
    });
    setShowEmailModal(true);
  };

  // Utility functions
  const MetricCard = ({ value, label, target, progress, progressType }) => (
    <div style={styles.metricCard}>
      <div style={styles.metricValue}>{value}</div>
      <div style={styles.metricLabel}>{label}</div>
      {target && (
        <div
          style={{
            color: "#28a745",
            fontSize: "0.8em",
            marginTop: "5px",
            fontWeight: "500",
          }}
        >
          Hedef: {target}
        </div>
      )}
      <div style={styles.progressBar}>
        <div
          style={{
            ...styles.progressFill,
            ...(progressType === "excellent"
              ? styles.progressExcellent
              : styles.progressGood),
            width: `${progress}%`,
          }}
        />
      </div>
    </div>
  );

  // DÃ¼zeltilmiÅŸ gÃ¼nlÃ¼k ortalama hesaplama fonksiyonu - izinliler hariÃ§
  const calculateMetrics = () => {
    if (dataEntries.length === 0)
      return {
        avgCalls: 0,
        avgProposals: 0,
        avgOnline: 0,
        avgPhysical: 0,
        avgTotal: 0,
        activeCount: 0,
      };

    const today = new Date().toISOString().split("T")[0];
    const todayEntries = dataEntries.filter(
      (e) => e.date === today && !e.on_leave,
    );

    if (todayEntries.length === 0)
      return {
        avgCalls: 0,
        avgProposals: 0,
        avgOnline: 0,
        avgPhysical: 0,
        avgTotal: 0,
        activeCount: 0,
      };

    return {
      avgCalls: (
        todayEntries.reduce((sum, e) => sum + (e.calls || 0), 0) /
        todayEntries.length
      ).toFixed(1),
      avgProposals: (
        todayEntries.reduce((sum, e) => sum + (e.proposals || 0), 0) /
        todayEntries.length
      ).toFixed(1),
      avgOnline: (
        todayEntries.reduce((sum, e) => sum + (e.online_visits || 0), 0) /
        todayEntries.length
      ).toFixed(1),
      avgPhysical: (
        todayEntries.reduce((sum, e) => sum + (e.physical_visits || 0), 0) /
        todayEntries.length
      ).toFixed(1),
      avgTotal: (
        todayEntries.reduce((sum, e) => sum + (e.total_visits || 0), 0) /
        todayEntries.length
      ).toFixed(1),
      activeCount: todayEntries.length,
    };
  };

  const getConnectionStatus = () => {
    if (supabaseKey === "BURAYA_ANON_KEY_YAZACAKSIN") {
      return {
        type: "error",
        message: "âŒ Supabase API anahtarlarÄ± henÃ¼z ayarlanmadÄ±!",
      };
    } else if (dataEntries.length > 0) {
      return {
        type: "success",
        message:
          "âœ… Supabase baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±! " +
          dataEntries.length +
          " kayÄ±t bulundu.",
      };
    } else {
      return {
        type: "warning",
        message: "âš ï¸ Supabase baÄŸlandÄ± ama henÃ¼z veri yok. Ä°lk kaydÄ± girin!",
      };
    }
  };

  const calculateMonthlyRankings = () => {
    const currentMonth = new Date().toISOString().slice(0, 7);
    const monthlyEntries = dataEntries.filter(
      (e) => e.date.startsWith(currentMonth) && !e.on_leave,
    );

    // Ä°ÅŸ gÃ¼nÃ¼ hesaplama - bugÃ¼ne kadar geÃ§en iÅŸ gÃ¼nleri
    const year = new Date().getFullYear();
    const month = new Date().getMonth();
    const workDaysUntilToday = getWorkDaysUntilToday(year, month);
    const totalWorkDaysInMonth = getWorkDaysInMonth(year, month);

    const employeeStats = {};
    monthlyEntries.forEach((entry) => {
      if (!employeeStats[entry.employee]) {
        employeeStats[entry.employee] = {
          name: entry.employee,
          team: entry.team,
          totalCalls: 0,
          totalProposals: 0,
          totalVisits: 0,
          days: 0,
        };
      }
      employeeStats[entry.employee].totalCalls += entry.calls || 0;
      employeeStats[entry.employee].totalProposals += entry.proposals || 0;
      employeeStats[entry.employee].totalVisits += entry.total_visits || 0;
      employeeStats[entry.employee].days += 1;
    });

    const teamStats = {};
    Object.values(employeeStats).forEach((emp) => {
      if (!teamStats[emp.team]) {
        teamStats[emp.team] = {
          name: emp.team,
          totalCalls: 0,
          totalProposals: 0,
          totalVisits: 0,
          employeeCount: 0,
          totalDays: 0,
        };
      }
      teamStats[emp.team].totalCalls += emp.totalCalls;
      teamStats[emp.team].totalProposals += emp.totalProposals;
      teamStats[emp.team].totalVisits += emp.totalVisits;
      teamStats[emp.team].employeeCount += 1;
      teamStats[emp.team].totalDays += emp.days;
    });

    const rankedEmployees = Object.values(employeeStats)
      .map((emp) => ({
        ...emp,
        avgCalls:
          workDaysUntilToday > 0
            ? (emp.totalCalls / workDaysUntilToday).toFixed(1)
            : 0,
        avgProposals:
          workDaysUntilToday > 0
            ? (emp.totalProposals / workDaysUntilToday).toFixed(1)
            : 0,
        avgVisits:
          workDaysUntilToday > 0
            ? (emp.totalVisits / workDaysUntilToday).toFixed(1)
            : 0,
      }))
      .sort((a, b) => b.totalVisits - a.totalVisits);

    const rankedTeams = Object.values(teamStats)
      .map((team) => ({
        ...team,
        avgCalls:
          workDaysUntilToday > 0
            ? (team.totalCalls / workDaysUntilToday).toFixed(1)
            : 0,
        avgProposals:
          workDaysUntilToday > 0
            ? (team.totalProposals / workDaysUntilToday).toFixed(1)
            : 0,
        avgVisits:
          workDaysUntilToday > 0
            ? (team.totalVisits / workDaysUntilToday).toFixed(1)
            : 0,
      }))
      .sort((a, b) => b.totalVisits - a.totalVisits);

    return {
      rankedEmployees,
      rankedTeams,
      workDays: workDaysUntilToday,
      totalWorkDays: totalWorkDaysInMonth,
    };
  };

  // Alt ekip ortalamalarÄ±nÄ± hesaplama fonksiyonu
  const calculateTeamMetrics = (teamName) => {
    const today = new Date().toISOString().split("T")[0];
    const teamEntries = dataEntries.filter(
      (e) => e.date === today && e.team === teamName && !e.on_leave,
    );

    if (teamEntries.length === 0)
      return { avgCalls: 0, avgProposals: 0, avgTotal: 0, activeCount: 0 };

    return {
      avgCalls: (
        teamEntries.reduce((sum, e) => sum + (e.calls || 0), 0) /
        teamEntries.length
      ).toFixed(1),
      avgProposals: (
        teamEntries.reduce((sum, e) => sum + (e.proposals || 0), 0) /
        teamEntries.length
      ).toFixed(1),
      avgTotal: (
        teamEntries.reduce((sum, e) => sum + (e.total_visits || 0), 0) /
        teamEntries.length
      ).toFixed(1),
      activeCount: teamEntries.length,
    };
  };

  const getUniqueTeams = () => {
    const teamNames = [...new Set(employees.map((emp) => emp.team))];
    // Ekipleri sÄ±ralÄ± olarak dÃ¶ndÃ¼r (1-2-3-4)
    return teamNames.sort((a, b) => {
      const numA = parseInt(a.split("-").pop());
      const numB = parseInt(b.split("-").pop());
      return numA - numB;
    });
  };

  const metrics = calculateMetrics();
  const connectionStatus = getConnectionStatus();
  const { rankedEmployees, rankedTeams, workDays, totalWorkDays } =
    calculateMonthlyRankings();

  // Render functions
  const renderDashboard = () => (
    <div ref={dashboardRef}>
      <div
        style={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
          marginBottom: "20px",
        }}
      >
        <h2 style={{ margin: 0, color: "#8315b5" }}>
          ğŸ“Š GÃ¼nlÃ¼k Ortalamalar & PaylaÅŸÄ±m
        </h2>
        <div style={styles.exportButtons}>
          <button
            style={{ ...styles.btn, ...styles.btnSuccess }}
            onClick={sendWhatsApp}
          >
            ğŸ“± WhatsApp GÃ¶nder
          </button>
          <button
            style={{ ...styles.btn, ...styles.btnInfo }}
            onClick={() => openEmailModal("screenshot")}
          >
            ğŸ“§ Email GÃ¶nder
          </button>
          <button
            style={{ ...styles.btn, ...styles.btnDanger }}
            onClick={refreshData}
            disabled={refreshing}
          >
            {refreshing ? "â³ Yenileniyor..." : "ğŸ”„ Verileri Yenile"}
          </button>
        </div>
      </div>

      <div
        style={{
          ...styles.statusInfo,
          ...(connectionStatus.type === "success"
            ? styles.statusSuccess
            : connectionStatus.type === "warning"
              ? styles.statusWarning
              : styles.statusError),
        }}
      >
        {connectionStatus.message}
      </div>

      {/* Genel Ekip Metrikleri */}
      <div ref={metricsRef} style={styles.metricsGrid}>
        <MetricCard
          value={metrics.avgCalls}
          label="Genel Ort. Arama"
          target={kpiTargets.calls || 45}
          progress={
            metrics.avgCalls
              ? Math.min(
                  (metrics.avgCalls / (kpiTargets.calls || 45)) * 100,
                  100,
                )
              : 0
          }
          progressType="good"
        />
        <MetricCard
          value={metrics.avgProposals}
          label="Genel Ort. Teklif"
          target={kpiTargets.proposals || 5}
          progress={
            metrics.avgProposals
              ? Math.min(
                  (metrics.avgProposals / (kpiTargets.proposals || 5)) * 100,
                  100,
                )
              : 0
          }
          progressType="good"
        />
        <MetricCard
          value={metrics.avgOnline}
          label="Genel Ort. Online Ziyaret"
          target={kpiTargets.online_visits || 2}
          progress={
            metrics.avgOnline
              ? Math.min(
                  (metrics.avgOnline / (kpiTargets.online_visits || 2)) * 100,
                  100,
                )
              : 0
          }
          progressType="excellent"
        />
        <MetricCard
          value={metrics.avgPhysical}
          label="Genel Ort. Fiziki Ziyaret"
          target={kpiTargets.physical_visits || 1}
          progress={
            metrics.avgPhysical
              ? Math.min(
                  (metrics.avgPhysical / (kpiTargets.physical_visits || 1)) *
                    100,
                  100,
                )
              : 0
          }
          progressType="excellent"
        />
        <MetricCard
          value={metrics.avgTotal}
          label="Genel Ort. Toplam Ziyaret"
          target={kpiTargets.total_visits || 3}
          progress={
            metrics.avgTotal
              ? Math.min(
                  (metrics.avgTotal / (kpiTargets.total_visits || 3)) * 100,
                  100,
                )
              : 0
          }
          progressType="excellent"
        />
        <MetricCard
          value={`${metrics.activeCount}/${employees.length}`}
          label="ğŸ‘¥ BugÃ¼n Aktif"
          target={`KatÄ±lÄ±m: ${Math.round((metrics.activeCount / employees.length) * 100)}%`}
          progress={Math.round((metrics.activeCount / employees.length) * 100)}
          progressType="excellent"
        />
      </div>

      {/* HiyerarÅŸik Ekip YapÄ±sÄ± - SÄ±ralÄ± */}
      <div style={styles.hierarchyContainer}>
        <h3 style={{ color: "#8315b5", marginBottom: "20px" }}>
          ğŸ¢ Ekip HiyerarÅŸisi ve GÃ¼nlÃ¼k Performans
        </h3>

        {getUniqueTeams().map((teamName) => {
          const teamMetrics = calculateTeamMetrics(teamName);
          const teamEmployees = employees.filter(
            (emp) => emp.team === teamName,
          );

          return (
            <div key={teamName} style={{ marginBottom: "25px" }}>
              <div style={styles.teamHeader}>
                <div
                  style={{
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                  }}
                >
                  <span>ğŸ¢ {teamName}</span>
                  <div style={{ fontSize: "0.9em", opacity: 0.9 }}>
                    Arama {teamMetrics.avgCalls} | Teklif{" "}
                    {teamMetrics.avgProposals} | Toplam Ziyaret{" "}
                    {teamMetrics.avgTotal} | ğŸ‘¥ {teamMetrics.activeCount}/
                    {teamEmployees.length}
                  </div>
                </div>
              </div>

              <div style={styles.employeeList}>
                {teamEmployees.map((emp) => {
                  const empEntries = dataEntries.filter(
                    (e) =>
                      e.date === new Date().toISOString().split("T")[0] &&
                      e.employee === emp.name,
                  );

                  const todayEntry = empEntries[0];
                  const isActive = todayEntry && !todayEntry.on_leave;
                  const isOnLeave = todayEntry && todayEntry.on_leave;

                  return (
                    <div
                      key={emp.name}
                      style={{
                        ...styles.employeeItem,
                        borderLeft: `4px solid ${isActive ? "#28a745" : isOnLeave ? "#ffc107" : "#dc3545"}`,
                      }}
                    >
                      <div>
                        <strong>{emp.name}</strong> - {emp.segment}
                        {isOnLeave && (
                          <span
                            style={{ color: "#ffc107", marginLeft: "10px" }}
                          >
                            ğŸ–ï¸ Ä°zinli
                          </span>
                        )}
                      </div>
                      <div style={{ fontSize: "0.9em" }}>
                        {isActive ? (
                          <>
                            Arama {todayEntry.calls} | Teklif{" "}
                            {todayEntry.proposals} | Toplam Ziyaret{" "}
                            {todayEntry.total_visits}
                          </>
                        ) : isOnLeave ? (
                          <span style={{ color: "#856404" }}>Ä°zinli</span>
                        ) : (
                          <span style={{ color: "#dc3545" }}>Veri yok</span>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          );
        })}
      </div>

      <div style={styles.formContainer}>
        <h3 style={{ color: "#8315b5", marginBottom: "20px" }}>
          ğŸš€ HÄ±zlÄ± Ä°ÅŸlemler
        </h3>
        <div style={{ display: "flex", gap: "10px", flexWrap: "wrap" }}>
          {teams.map((team) => (
            <button
              key={team.name}
              style={{ ...styles.btn, ...styles.btnWarning }}
              onClick={() => setActiveTab("bulk-entry")}
            >
              ğŸ“ {team.name} Toplu GiriÅŸ
            </button>
          ))}
        </div>
      </div>
    </div>
  );

  const renderDataEntry = () => (
    <div style={styles.formContainer}>
      <h2 style={{ marginBottom: "20px", color: "#8315b5" }}>
        ğŸ“ Tekli Veri GiriÅŸi
      </h2>

      <div style={styles.formGrid}>
        <div>
          <div style={styles.formGroup}>
            <div style={styles.label}>ğŸ“… Tarih</div>
            <input
              type="date"
              name="date"
              value={formData.date}
              onChange={handleInputChange}
              style={styles.formControl}
              disabled={loading}
            />
          </div>
          <div style={styles.formGroup}>
            <div style={styles.label}>ğŸ‘¤ Ã‡alÄ±ÅŸan SeÃ§in</div>
            <select
              name="employee"
              value={formData.employee}
              onChange={handleInputChange}
              style={styles.formControl}
              disabled={loading}
            >
              <option value="">-- Ã‡alÄ±ÅŸan SeÃ§in --</option>
              {employees.map((emp) => (
                <option key={emp.name} value={emp.name}>
                  {emp.name}
                </option>
              ))}
            </select>
          </div>
          {selectedEmployee && (
            <>
              <div style={styles.formGroup}>
                <div style={styles.label}>ğŸ¢ Ekip</div>
                <div style={styles.autoField}>{selectedEmployee.team}</div>
              </div>
              <div style={styles.formGroup}>
                <div style={styles.label}>ğŸ“‹ Segment</div>
                <div style={styles.autoField}>{selectedEmployee.segment}</div>
              </div>
            </>
          )}
        </div>
        <div>
          <div style={styles.formGroup}>
            <div style={styles.label}>Arama SayÄ±sÄ±</div>
            <input
              type="number"
              name="calls"
              value={formData.calls}
              onChange={handleInputChange}
              style={styles.formControl}
              placeholder={`Hedef: ${kpiTargets.calls || 45}`}
              disabled={formData.onLeave || loading}
            />
          </div>
          <div style={styles.formGroup}>
            <div style={styles.label}>Teklif SayÄ±sÄ±</div>
            <input
              type="number"
              name="proposals"
              value={formData.proposals}
              onChange={handleInputChange}
              style={styles.formControl}
              placeholder={`Hedef: ${kpiTargets.proposals || 5}`}
              disabled={formData.onLeave || loading}
            />
          </div>
          <div style={styles.formGroup}>
            <div style={styles.label}>Online Ziyaret</div>
            <input
              type="number"
              name="onlineVisits"
              value={formData.onlineVisits}
              onChange={handleInputChange}
              style={styles.formControl}
              placeholder={kpiTargets.online_visits || 2}
              disabled={formData.onLeave || loading}
            />
          </div>
          <div style={styles.formGroup}>
            <div style={styles.label}>Fiziki Ziyaret</div>
            <input
              type="number"
              name="physicalVisits"
              value={formData.physicalVisits}
              onChange={handleInputChange}
              style={styles.formControl}
              placeholder={kpiTargets.physical_visits || 1}
              disabled={formData.onLeave || loading}
            />
          </div>
          <div style={styles.formGroup}>
            <div style={styles.label}>
              <input
                type="checkbox"
                name="onLeave"
                checked={formData.onLeave}
                onChange={handleInputChange}
                style={{ marginRight: "8px" }}
                disabled={loading}
              />
              ğŸ–ï¸ Ä°zinli/Hasta
            </div>
          </div>
        </div>
      </div>

      <div style={{ display: "flex", gap: "10px", marginTop: "20px" }}>
        <button
          onClick={handleSubmit}
          style={{ ...styles.btn, ...styles.btnSuccess, flex: 1 }}
          disabled={loading || connectionStatus.type === "error"}
        >
          {loading ? "â³ Kaydediyor..." : "ğŸ’¾ Kaydet"}
        </button>
      </div>

      {/* VERÄ° SÄ°LME Ã–ZELLÄ°KLERÄ° */}
      {dataEntries.length > 0 && (
        <div style={{ marginTop: "30px" }}>
          <div
            style={{
              display: "flex",
              justifyContent: "space-between",
              alignItems: "center",
              marginBottom: "15px",
            }}
          >
            <h3 style={{ color: "#8315b5", margin: 0 }}>
              ğŸ“‹ Son Veriler & Silme Ä°ÅŸlemleri
            </h3>
            <div>
              <button
                onClick={() =>
                  deleteAllData(new Date().toISOString().split("T")[0])
                }
                style={{
                  ...styles.btn,
                  ...styles.btnDanger,
                  padding: "8px 15px",
                }}
              >
                ğŸ—‘ï¸ BugÃ¼nkÃ¼ TÃ¼m Verileri Sil
              </button>
            </div>
          </div>
          <div style={{ overflowX: "auto" }}>
            <table style={styles.table}>
              <thead>
                <tr>
                  <th style={styles.tableHeader}>Tarih</th>
                  <th style={styles.tableHeader}>Ã‡alÄ±ÅŸan</th>
                  <th style={styles.tableHeader}>Ekip</th>
                  <th style={styles.tableHeader}>Arama</th>
                  <th style={styles.tableHeader}>Teklif</th>
                  <th style={styles.tableHeader}>Online</th>
                  <th style={styles.tableHeader}>Fiziki</th>
                  <th style={styles.tableHeader}>Toplam</th>
                  <th style={styles.tableHeader}>Durum</th>
                  <th style={styles.tableHeader}>Ä°ÅŸlemler</th>
                </tr>
              </thead>
              <tbody>
                {dataEntries.slice(0, 20).map((entry, index) => (
                  <tr
                    key={entry.id || index}
                    style={
                      index % 2 === 0 ? { backgroundColor: "#f8f9fa" } : {}
                    }
                  >
                    <td style={styles.tableCell}>{entry.date}</td>
                    <td style={styles.tableCell}>
                      <strong>{entry.employee}</strong>
                    </td>
                    <td style={styles.tableCell}>{entry.team}</td>
                    <td style={styles.tableCell}>
                      {entry.on_leave ? "-" : entry.calls}
                    </td>
                    <td style={styles.tableCell}>
                      {entry.on_leave ? "-" : entry.proposals}
                    </td>
                    <td style={styles.tableCell}>
                      {entry.on_leave ? "-" : entry.online_visits}
                    </td>
                    <td style={styles.tableCell}>
                      {entry.on_leave ? "-" : entry.physical_visits}
                    </td>
                    <td style={styles.tableCell}>
                      <strong>
                        {entry.on_leave ? "-" : entry.total_visits}
                      </strong>
                    </td>
                    <td style={styles.tableCell}>
                      <span
                        style={{
                          color: entry.on_leave ? "#ffc107" : "#28a745",
                          fontWeight: "bold",
                        }}
                      >
                        {entry.on_leave ? "ğŸ–ï¸ Ä°zinli" : "âœ… Aktif"}
                      </span>
                    </td>
                    <td style={styles.tableCell}>
                      <div style={{ display: "flex", gap: "5px" }}>
                        <button
                          onClick={() =>
                            deleteIndividualData(entry.employee, entry.date)
                          }
                          style={{
                            ...styles.btn,
                            ...styles.btnDanger,
                            padding: "3px 8px",
                            margin: 0,
                            fontSize: "11px",
                          }}
                          title="Bu kaydÄ± sil"
                        >
                          ğŸ—‘ï¸
                        </button>
                        <button
                          onClick={() => deleteTeamData(entry.team, entry.date)}
                          style={{
                            ...styles.btn,
                            ...styles.btnWarning,
                            padding: "3px 8px",
                            margin: 0,
                            fontSize: "11px",
                          }}
                          title="Bu tarihte ekibin tÃ¼m verilerini sil"
                        >
                          ğŸ¢ğŸ—‘ï¸
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}
    </div>
  );

  // YENÄ°: Toplu Ä°ÅŸlem Sekmesi
  const renderBulkEntry = () => (
    <div>
      <h2 style={{ marginBottom: "20px", color: "#8315b5" }}>
        ğŸ“ Toplu Veri GiriÅŸi
      </h2>

      <div style={styles.formContainer}>
        <div style={styles.formGroup}>
          <div style={styles.label}>ğŸ“… Tarih</div>
          <input
            type="date"
            value={bulkFormData.date}
            onChange={(e) =>
              setBulkFormData((prev) => ({ ...prev, date: e.target.value }))
            }
            style={styles.formControl}
          />
        </div>

        <div style={styles.formGroup}>
          <div style={styles.label}>ğŸ¢ Ekip SeÃ§in</div>
          <select
            value={bulkFormData.team}
            onChange={(e) => handleBulkTeamSelect(e.target.value)}
            style={styles.formControl}
          >
            <option value="">-- Ekip SeÃ§in --</option>
            {getUniqueTeams().map((team) => (
              <option key={team} value={team}>
                {team}
              </option>
            ))}
          </select>
        </div>

        {bulkFormData.employees.length > 0 && (
          <div>
            <h3 style={{ color: "#8315b5", marginBottom: "15px" }}>
              ğŸ“Š {bulkFormData.team} - Ã‡alÄ±ÅŸan Verileri
            </h3>

            {bulkFormData.employees.map((emp, index) => (
              <div
                key={emp.name}
                style={{
                  background: "#f8f9fa",
                  padding: "15px",
                  borderRadius: "8px",
                  marginBottom: "15px",
                  border: "1px solid #dee2e6",
                }}
              >
                <div
                  style={{
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                    marginBottom: "10px",
                  }}
                >
                  <h4 style={{ margin: 0, color: "#8315b5" }}>{emp.name}</h4>
                  <label style={{ color: "#ffc107" }}>
                    <input
                      type="checkbox"
                      checked={emp.onLeave}
                      onChange={(e) =>
                        handleBulkEmployeeChange(
                          index,
                          "onLeave",
                          e.target.checked,
                        )
                      }
                      style={{ marginRight: "5px" }}
                    />
                    ğŸ–ï¸ Ä°zinli
                  </label>
                </div>

                <div style={styles.bulkGrid}>
                  <div>
                    <label style={{ fontSize: "0.8em", color: "#666" }}>
                      Arama
                    </label>
                    <input
                      type="number"
                      value={emp.calls}
                      onChange={(e) =>
                        handleBulkEmployeeChange(index, "calls", e.target.value)
                      }
                      style={styles.bulkInput}
                      placeholder={kpiTargets.calls || 45}
                      disabled={emp.onLeave}
                    />
                  </div>
                  <div>
                    <label style={{ fontSize: "0.8em", color: "#666" }}>
                      Teklif
                    </label>
                    <input
                      type="number"
                      value={emp.proposals}
                      onChange={(e) =>
                        handleBulkEmployeeChange(
                          index,
                          "proposals",
                          e.target.value,
                        )
                      }
                      style={styles.bulkInput}
                      placeholder={kpiTargets.proposals || 5}
                      disabled={emp.onLeave}
                    />
                  </div>
                  <div>
                    <label style={{ fontSize: "0.8em", color: "#666" }}>
                      Online
                    </label>
                    <input
                      type="number"
                      value={emp.onlineVisits}
                      onChange={(e) =>
                        handleBulkEmployeeChange(
                          index,
                          "onlineVisits",
                          e.target.value,
                        )
                      }
                      style={styles.bulkInput}
                      placeholder={kpiTargets.online_visits || 2}
                      disabled={emp.onLeave}
                    />
                  </div>
                  <div>
                    <label style={{ fontSize: "0.8em", color: "#666" }}>
                      Fiziki
                    </label>
                    <input
                      type="number"
                      value={emp.physicalVisits}
                      onChange={(e) =>
                        handleBulkEmployeeChange(
                          index,
                          "physicalVisits",
                          e.target.value,
                        )
                      }
                      style={styles.bulkInput}
                      placeholder={kpiTargets.physical_visits || 1}
                      disabled={emp.onLeave}
                    />
                  </div>
                </div>
              </div>
            ))}

            <div style={{ marginTop: "20px" }}>
              <button
                onClick={submitBulkData}
                style={{ ...styles.btn, ...styles.btnSuccess }}
                disabled={loading}
              >
                {loading ? "â³ Kaydediyor..." : "ğŸ’¾ Toplu Kaydet"}
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );

  // AylÄ±k sÄ±ralama - Ä°ÅŸ gÃ¼nÃ¼ bazlÄ± ortalama
  const renderMonthly = () => (
    <div>
      <div
        style={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
          marginBottom: "20px",
        }}
      >
        <h2 style={{ color: "#8315b5", margin: 0 }}>
          ğŸ“Š AylÄ±k Performans SÄ±ralamasÄ± (BugÃ¼ne Kadar {workDays} Ä°ÅŸ GÃ¼nÃ¼)
        </h2>
        <div style={styles.exportButtons}>
          <button
            style={{ ...styles.btn, ...styles.btnSuccess }}
            onClick={() => {
              const exportData = rankedEmployees.map((emp) => ({
                SÄ±ra: rankedEmployees.indexOf(emp) + 1,
                Ã‡alÄ±ÅŸan: emp.name,
                Ekip: emp.team,
                "Ort Arama": emp.avgCalls,
                "Ort Teklif": emp.avgProposals,
                "Ort Ziyaret": emp.avgVisits,
                "GÃ¼n SayÄ±sÄ±": emp.days,
              }));
              exportToExcel(exportData, "aylik_sirala_bireysel");
            }}
          >
            ğŸ“Š Bireysel Excel
          </button>
          <button
            style={{ ...styles.btn, ...styles.btnInfo }}
            onClick={() => {
              const exportData = rankedTeams.map((team) => ({
                SÄ±ra: rankedTeams.indexOf(team) + 1,
                Ekip: team.name,
                "GÃ¼nlÃ¼k Ort Arama": team.avgCalls,
                "GÃ¼nlÃ¼k Ort Teklif": team.avgProposals,
                "GÃ¼nlÃ¼k Ort Ziyaret": team.avgVisits,
                "Ã‡alÄ±ÅŸan SayÄ±sÄ±": team.employeeCount,
                "Ä°ÅŸ GÃ¼nÃ¼": workDays,
              }));
              exportToExcel(exportData, "aylik_sirala_ekip");
            }}
          >
            ğŸ¢ Ekip Excel
          </button>
          <button
            style={{ ...styles.btn, ...styles.btnWarning }}
            onClick={() => openEmailModal("report", rankedEmployees)}
          >
            ğŸ“§ Rapor Email
          </button>
        </div>
      </div>

      <div style={styles.metricsGrid}>
        <MetricCard
          value={rankedEmployees.length.toString()}
          label="ğŸ‘¥ Aktif Ã‡alÄ±ÅŸan"
        />
        <MetricCard
          value={rankedTeams.length.toString()}
          label="ğŸ¢ Aktif Ekip"
        />
        <MetricCard
          value={dataEntries
            .filter((e) =>
              e.date.startsWith(new Date().toISOString().slice(0, 7)),
            )
            .length.toString()}
          label="ğŸ“ˆ Bu Ay Toplam GiriÅŸ"
        />
        <MetricCard
          value={`${workDays}/${totalWorkDays}`}
          label="ğŸ“… Ä°ÅŸ GÃ¼nÃ¼ (GeÃ§en/Toplam)"
        />
      </div>

      <div style={styles.formContainer}>
        <h3 style={{ color: "#8315b5", marginBottom: "20px" }}>
          ğŸ† Ekip SÄ±ralamasÄ± (GÃ¼nlÃ¼k Ortalama - BugÃ¼ne Kadar {workDays} Ä°ÅŸ GÃ¼nÃ¼)
        </h3>
        <table style={styles.table}>
          <thead>
            <tr>
              <th style={styles.tableHeader}>SÄ±ra</th>
              <th style={styles.tableHeader}>Ekip</th>
              <th style={styles.tableHeader}>GÃ¼nlÃ¼k Ort. Arama</th>
              <th style={styles.tableHeader}>GÃ¼nlÃ¼k Ort. Teklif</th>
              <th style={styles.tableHeader}>GÃ¼nlÃ¼k Ort. Ziyaret</th>
              <th style={styles.tableHeader}>ğŸ‘¥ Ã‡alÄ±ÅŸan</th>
            </tr>
          </thead>
          <tbody>
            {rankedTeams.map((team, index) => (
              <tr
                key={team.name}
                style={
                  index < 3
                    ? { backgroundColor: "#f8f9fa", fontWeight: "bold" }
                    : {}
                }
              >
                <td style={styles.tableCell}>
                  {index === 0
                    ? "ğŸ¥‡"
                    : index === 1
                      ? "ğŸ¥ˆ"
                      : index === 2
                        ? "ğŸ¥‰"
                        : index + 1}
                </td>
                <td style={styles.tableCell}>
                  <strong>{team.name}</strong>
                </td>
                <td style={styles.tableCell}>{team.avgCalls}</td>
                <td style={styles.tableCell}>{team.avgProposals}</td>
                <td style={styles.tableCell}>{team.avgVisits}</td>
                <td style={styles.tableCell}>{team.employeeCount}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      <div style={styles.formContainer}>
        <h3 style={{ color: "#8315b5", marginBottom: "20px" }}>
          ğŸ† Bireysel SÄ±ralama (GÃ¼nlÃ¼k Ortalama - BugÃ¼ne Kadar {workDays} Ä°ÅŸ
          GÃ¼nÃ¼)
        </h3>
        <table style={styles.table}>
          <thead>
            <tr>
              <th style={styles.tableHeader}>SÄ±ra</th>
              <th style={styles.tableHeader}>Ã‡alÄ±ÅŸan</th>
              <th style={styles.tableHeader}>Ekip</th>
              <th style={styles.tableHeader}>GÃ¼nlÃ¼k Ort. Arama</th>
              <th style={styles.tableHeader}>GÃ¼nlÃ¼k Ort. Teklif</th>
              <th style={styles.tableHeader}>GÃ¼nlÃ¼k Ort. Ziyaret</th>
              <th style={styles.tableHeader}>ğŸ“… Veri Girilen GÃ¼n</th>
            </tr>
          </thead>
          <tbody>
            {rankedEmployees.slice(0, 20).map((employee, index) => (
              <tr
                key={employee.name}
                style={
                  index < 3
                    ? { backgroundColor: "#f8f9fa", fontWeight: "bold" }
                    : {}
                }
              >
                <td style={styles.tableCell}>
                  {index === 0
                    ? "ğŸ¥‡"
                    : index === 1
                      ? "ğŸ¥ˆ"
                      : index === 2
                        ? "ğŸ¥‰"
                        : index + 1}
                </td>
                <td style={styles.tableCell}>
                  <strong>{employee.name}</strong>
                </td>
                <td style={styles.tableCell}>{employee.team}</td>
                <td style={styles.tableCell}>{employee.avgCalls}</td>
                <td style={styles.tableCell}>{employee.avgProposals}</td>
                <td style={styles.tableCell}>{employee.avgVisits}</td>
                <td style={styles.tableCell}>{employee.days}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );

  // YENÄ°: Admin Paneli
  const renderAdmin = () => (
    <div>
      <h2 style={{ marginBottom: "20px", color: "#8315b5" }}>
        ğŸ‘¨â€ğŸ’¼ Admin Paneli
      </h2>

      {/* Ã‡alÄ±ÅŸan YÃ¶netimi */}
      <div style={styles.adminCard}>
        <h3 style={{ color: "#8315b5", marginBottom: "15px" }}>
          ğŸ‘¥ Ã‡alÄ±ÅŸan YÃ¶netimi
        </h3>

        <div style={styles.formGrid}>
          <div>
            <div style={styles.formGroup}>
              <div style={styles.label}>ğŸ‘¤ Yeni Ã‡alÄ±ÅŸan AdÄ±</div>
              <input
                type="text"
                value={adminFormData.newEmployee.name}
                onChange={(e) =>
                  setAdminFormData((prev) => ({
                    ...prev,
                    newEmployee: { ...prev.newEmployee, name: e.target.value },
                  }))
                }
                style={styles.formControl}
                placeholder="Ã‡alÄ±ÅŸan adÄ± girin"
              />
            </div>
          </div>
          <div>
            <div style={styles.formGroup}>
              <div style={styles.label}>ğŸ¢ Ekip</div>
              <select
                value={adminFormData.newEmployee.team}
                onChange={(e) =>
                  setAdminFormData((prev) => ({
                    ...prev,
                    newEmployee: { ...prev.newEmployee, team: e.target.value },
                  }))
                }
                style={styles.formControl}
              >
                <option value="">-- Ekip SeÃ§in --</option>
                {getUniqueTeams().map((team) => (
                  <option key={team} value={team}>
                    {team}
                  </option>
                ))}
              </select>
            </div>
          </div>
          <div>
            <div style={styles.formGroup}>
              <div style={styles.label}>ğŸ“‹ Segment</div>
              <select
                value={adminFormData.newEmployee.segment}
                onChange={(e) =>
                  setAdminFormData((prev) => ({
                    ...prev,
                    newEmployee: {
                      ...prev.newEmployee,
                      segment: e.target.value,
                    },
                  }))
                }
                style={styles.formControl}
              >
                <option value="BM">BM</option>
                <option value="Ã–M">Ã–M</option>
              </select>
            </div>
          </div>
        </div>

        <button
          onClick={addNewEmployee}
          style={{ ...styles.btn, ...styles.btnSuccess }}
        >
          â• Ã‡alÄ±ÅŸan Ekle
        </button>
      </div>

      {/* KPI Hedef YÃ¶netimi */}
      <div style={styles.adminCard}>
        <h3 style={{ color: "#8315b5", marginBottom: "15px" }}>
          ğŸ¯ KPI Hedef YÃ¶netimi
        </h3>

        <div style={styles.formGrid}>
          <div style={styles.formGroup}>
            <div style={styles.label}>ğŸ“ Arama Hedefi</div>
            <input
              type="number"
              value={
                adminFormData.kpiUpdates.calls !== undefined
                  ? adminFormData.kpiUpdates.calls
                  : kpiTargets.calls
              }
              onChange={(e) =>
                setAdminFormData((prev) => ({
                  ...prev,
                  kpiUpdates: {
                    ...prev.kpiUpdates,
                    calls: parseInt(e.target.value),
                  },
                }))
              }
              style={styles.formControl}
              placeholder="45"
            />
          </div>
          <div style={styles.formGroup}>
            <div style={styles.label}>ğŸ“„ Teklif Hedefi</div>
            <input
              type="number"
              value={
                adminFormData.kpiUpdates.proposals !== undefined
                  ? adminFormData.kpiUpdates.proposals
                  : kpiTargets.proposals
              }
              onChange={(e) =>
                setAdminFormData((prev) => ({
                  ...prev,
                  kpiUpdates: {
                    ...prev.kpiUpdates,
                    proposals: parseInt(e.target.value),
                  },
                }))
              }
              style={styles.formControl}
              placeholder="5"
            />
          </div>
          <div style={styles.formGroup}>
            <div style={styles.label}>ğŸ’» Online Ziyaret Hedefi</div>
            <input
              type="number"
              value={
                adminFormData.kpiUpdates.online_visits !== undefined
                  ? adminFormData.kpiUpdates.online_visits
                  : kpiTargets.online_visits
              }
              onChange={(e) =>
                setAdminFormData((prev) => ({
                  ...prev,
                  kpiUpdates: {
                    ...prev.kpiUpdates,
                    online_visits: parseInt(e.target.value),
                  },
                }))
              }
              style={styles.formControl}
              placeholder="2"
            />
          </div>
          <div style={styles.formGroup}>
            <div style={styles.label}>ğŸƒâ€â™‚ï¸ Fiziki Ziyaret Hedefi</div>
            <input
              type="number"
              value={
                adminFormData.kpiUpdates.physical_visits !== undefined
                  ? adminFormData.kpiUpdates.physical_visits
                  : kpiTargets.physical_visits
              }
              onChange={(e) =>
                setAdminFormData((prev) => ({
                  ...prev,
                  kpiUpdates: {
                    ...prev.kpiUpdates,
                    physical_visits: parseInt(e.target.value),
                  },
                }))
              }
              style={styles.formControl}
              placeholder="1"
            />
          </div>
          <div style={styles.formGroup}>
            <div style={styles.label}>ğŸ¯ Toplam Ziyaret Hedefi</div>
            <input
              type="number"
              value={
                adminFormData.kpiUpdates.total_visits !== undefined
                  ? adminFormData.kpiUpdates.total_visits
                  : kpiTargets.total_visits
              }
              onChange={(e) =>
                setAdminFormData((prev) => ({
                  ...prev,
                  kpiUpdates: {
                    ...prev.kpiUpdates,
                    total_visits: parseInt(e.target.value),
                  },
                }))
              }
              style={styles.formControl}
              placeholder="3"
            />
          </div>
        </div>

        <button
          onClick={updateKpiTargets}
          style={{ ...styles.btn, ...styles.btnInfo }}
        >
          ğŸ¯ Hedefleri GÃ¼ncelle
        </button>
      </div>

      {/* Mevcut Ã‡alÄ±ÅŸanlar */}
      <div style={styles.formContainer}>
        <h3 style={{ color: "#8315b5", marginBottom: "20px" }}>
          ğŸ‘¥ Mevcut Ã‡alÄ±ÅŸanlar
        </h3>
        <div style={{ overflowX: "auto" }}>
          <table style={styles.table}>
            <thead>
              <tr>
                <th style={styles.tableHeader}>Ã‡alÄ±ÅŸan</th>
                <th style={styles.tableHeader}>Ekip</th>
                <th style={styles.tableHeader}>Segment</th>
                <th style={styles.tableHeader}>Performans</th>
                <th style={styles.tableHeader}>Ä°ÅŸlemler</th>
              </tr>
            </thead>
            <tbody>
              {employees.map((emp, index) => (
                <tr
                  key={emp.name}
                  style={index % 2 === 0 ? { backgroundColor: "#f8f9fa" } : {}}
                >
                  <td style={styles.tableCell}>
                    <strong>{emp.name}</strong>
                  </td>
                  <td style={styles.tableCell}>{emp.team}</td>
                  <td style={styles.tableCell}>{emp.segment}</td>
                  <td style={styles.tableCell}>
                    {emp.performance.toFixed(1)}%
                  </td>
                  <td style={styles.tableCell}>
                    <button
                      onClick={() => deleteEmployee(emp.name)}
                      style={{
                        ...styles.btn,
                        ...styles.btnDanger,
                        padding: "5px 10px",
                        margin: 0,
                      }}
                    >
                      ğŸ—‘ï¸ Sil
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );

  // YENÄ°: Åifre YÃ¶netimi (DÃ¼zeltilmiÅŸ)
  const renderPasswordManagement = () => (
    <div>
      <h2 style={{ marginBottom: "20px", color: "#8315b5" }}>
        ğŸ” Åifre YÃ¶netimi
      </h2>

      {/* Admin Åifre DeÄŸiÅŸtirme */}
      <div style={styles.adminCard}>
        <h3 style={{ color: "#8315b5", marginBottom: "15px" }}>
          ğŸ‘¨â€ğŸ’¼ Admin Åifre DeÄŸiÅŸtirme
        </h3>

        <div style={styles.formGrid}>
          <div style={styles.formGroup}>
            <div style={styles.label}>ğŸ”’ Mevcut Åifre</div>
            <input
              type="password"
              value={oldPasswordInput}
              onChange={(e) => setOldPasswordInput(e.target.value)}
              style={styles.formControl}
              placeholder="Mevcut admin ÅŸifresi"
            />
          </div>
          <div style={styles.formGroup}>
            <div style={styles.label}>ğŸ”‘ Yeni Åifre</div>
            <input
              type="password"
              value={newPasswordInput}
              onChange={(e) => setNewPasswordInput(e.target.value)}
              style={styles.formControl}
              placeholder="Yeni admin ÅŸifresi"
            />
          </div>
        </div>

        <button
          onClick={changeAdminPassword}
          style={{ ...styles.btn, ...styles.btnWarning }}
        >
          ğŸ”„ Admin Åifresi DeÄŸiÅŸtir
        </button>

        <div
          style={{
            marginTop: "15px",
            padding: "10px",
            background: "#fff3cd",
            borderRadius: "8px",
            border: "1px solid #ffc107",
          }}
        >
          <strong>ğŸ’¡ Mevcut Admin Åifresi:</strong>
          <span style={styles.passwordHidden}>â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
        </div>
      </div>

      {/* Ekip Åifre YÃ¶netimi */}
      <div style={styles.formContainer}>
        <h3 style={{ color: "#8315b5", marginBottom: "20px" }}>
          ğŸ¢ Ekip Åifre YÃ¶netimi
        </h3>

        <div style={styles.metricsGrid}>
          {getUniqueTeams().map((teamName) => {
            const team = teams.find((t) => t.name === teamName) || {
              name: teamName,
              password: "team1234",
            };
            return (
              <div key={team.name} style={styles.metricCard}>
                <h4 style={{ color: "#8315b5", marginBottom: "15px" }}>
                  {team.name}
                </h4>

                <div
                  style={{
                    marginBottom: "15px",
                    padding: "10px",
                    background: "#e8f5e8",
                    borderRadius: "6px",
                  }}
                >
                  <strong>Mevcut Åifre:</strong>
                  <span style={styles.passwordHidden}>â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
                </div>

                <button
                  onClick={() => changeTeamPassword(team.name)}
                  style={{ ...styles.btn, ...styles.btnInfo, width: "100%" }}
                >
                  ğŸ”„ Åifre DeÄŸiÅŸtir
                </button>
              </div>
            );
          })}
        </div>
      </div>

      {/* Åifre GÃ¼venlik Bilgileri */}
      <div
        style={{
          ...styles.statusInfo,
          ...styles.statusWarning,
        }}
      >
        <h4>ğŸ”’ Åifre GÃ¼venlik KurallarÄ±:</h4>
        <ul style={{ marginLeft: "20px", marginTop: "10px" }}>
          <li>Admin ÅŸifresi tÃ¼m sisteme eriÅŸim saÄŸlar</li>
          <li>
            Ekip ÅŸifreleri sadece o ekibin toplu veri giriÅŸi iÃ§in kullanÄ±lÄ±r
          </li>
          <li>Åifreler dÃ¼zenli olarak deÄŸiÅŸtirilmelidir</li>
          <li>Åifreleri gÃ¼venli yerlerde saklayÄ±n</li>
        </ul>
      </div>
    </div>
  );

  const renderTabContent = () => {
    switch (activeTab) {
      case "dashboard":
        return renderDashboard();
      case "data-entry":
        return renderDataEntry();
      case "bulk-entry":
        return renderBulkEntry();
      case "monthly":
        return renderMonthly();
      case "admin":
        return renderAdmin();
      case "password":
        return renderPasswordManagement();
      default:
        return renderDashboard();
    }
  };

  return (
    <div
      style={{
        fontFamily: '"Segoe UI", Tahoma, Geneva, Verdana, sans-serif',
        background: "linear-gradient(135deg, #8315b5, #5a0e7a)",
        minHeight: "100vh",
        color: "#333",
        lineHeight: "1.6",
      }}
    >
      <div style={styles.container}>
        <div style={styles.header}>
          <h1 style={styles.headerTitle}>
            ğŸ“Š Ä°stanbul MÃ¼ÅŸteriler KPI Dashboard
          </h1>
          <div style={{ opacity: 0.9, fontSize: "1.1em", fontWeight: "300" }}>
            {new Date().toLocaleDateString("tr-TR", {
              weekday: "long",
              year: "numeric",
              month: "long",
              day: "numeric",
            })}{" "}
            - (Ä°stanbul MÃ¼ÅŸteriler iÃ§in hazÄ±rlanmÄ±ÅŸtÄ±r)
          </div>
        </div>

        <nav style={styles.navBar}>
          {[
            { id: "dashboard", label: "ğŸ“Š Dashboard" },
            { id: "data-entry", label: "ğŸ“ Veri GiriÅŸi" },
            { id: "bulk-entry", label: "ğŸ“‹ Toplu Ä°ÅŸlem" },
            { id: "monthly", label: "ğŸ† AylÄ±k SÄ±ralama" },
            { id: "admin", label: "ğŸ‘¨â€ğŸ’¼ Admin" },
            { id: "password", label: "ğŸ” Åifre YÃ¶netimi" },
          ].map((tab) => (
            <button
              key={tab.id}
              style={{
                ...styles.navTab,
                ...(activeTab === tab.id ? styles.navTabActive : {}),
              }}
              onClick={() => setActiveTab(tab.id)}
            >
              {tab.label}
            </button>
          ))}
        </nav>

        <div style={styles.content}>{renderTabContent()}</div>
      </div>

      {/* Email Modal */}
      {showEmailModal && (
        <div
          style={{
            position: "fixed",
            top: 0,
            left: 0,
            width: "100%",
            height: "100%",
            background: "rgba(0,0,0,0.5)",
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            zIndex: 1000,
          }}
        >
          <div
            style={{
              background: "white",
              padding: "30px",
              borderRadius: "12px",
              width: "90%",
              maxWidth: "500px",
              boxShadow: "0 8px 25px rgba(0, 0, 0, 0.3)",
            }}
          >
            <h3>ğŸ“§ Email GÃ¶nder</h3>
            <div style={styles.formGroup}>
              <div style={styles.label}>ğŸ‘¤ AlÄ±cÄ± Email</div>
              <input
                type="email"
                style={styles.formControl}
                placeholder="ornek@email.com"
                value={emailData.recipient}
                onChange={(e) =>
                  setEmailData((prev) => ({
                    ...prev,
                    recipient: e.target.value,
                  }))
                }
              />
            </div>
            <div style={styles.formGroup}>
              <div style={styles.label}>ğŸ“ Konu</div>
              <input
                type="text"
                style={styles.formControl}
                value={emailData.subject}
                onChange={(e) =>
                  setEmailData((prev) => ({ ...prev, subject: e.target.value }))
                }
              />
            </div>
            <div style={{ marginTop: "20px", display: "flex", gap: "10px" }}>
              <button
                style={{ ...styles.btn, ...styles.btnSuccess }}
                onClick={() => sendEmail("screenshot")}
              >
                ğŸ“§ GÃ¶nder
              </button>
              <button
                style={styles.btn}
                onClick={() => setShowEmailModal(false)}
              >
                âŒ Ä°ptal
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default KPIDashboard;
